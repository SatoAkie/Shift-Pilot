{% extends "base.html" %}

{% block extra_css %}
<style>
.gray-btn {
    background-color: #dee2e6;
}
.gray-btn:hover,
.gray-btn:focus {
    background-color: #adb5bd;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.2); 
    color: #000;
    border: 1px solid #bbb;
}

.return-link:hover {
  text-decoration: underline !important;
}

.shift-cell {
    background-color: #e3f2fd !important;
    border: 1px solid #dee2e6 !important;
}

select.form-select {
    width: 80px !important;
    min-width: auto !important;
    padding: 2px 1.8rem 2px .5rem !important;
    background-position: right .5rem center !important;
    font-size: 0.85rem !important;
    line-height: 1.2 !important;
}
td.shift-cell {
    max-width: 90px;
    height: 70px;
    vertical-align: middle !important;
    padding: 4px !important;
    white-space: nowrap;
    overflow: hidden;
}
td.username-cell {
    text-align: center !important;
    vertical-align: middle !important;
    font-weight: bold;
    padding: 4px;
    height: 70px;
    white-space: nowrap;
    display: table-cell;
    position: sticky;
    left: 0;
    background-color: #fff;
    z-index: 3; 
}
th.username-header {
  position: sticky;
  left: 0;
  top: 0;
  background-color: #f8f9fa;
  z-index: 4; 
}
.shift-description {
  position: sticky;
  top: 0; 
  background-color: #fff;
  z-index: 5;
  padding: 4px 0;
}
.table td {
  padding-left: 1.5rem;
  padding-right: 1.5rem;
}
select.form-select.border-danger {
    border-width: 2px !important;
}
.form-select.rest-blue { 
  color: #0d6efd !important; 
  font-weight: 600; 
}
.form-select.rest-gray {
  color: #6c757d !important;
}
option.rest-request {
  color: #0d6efd;
  font-weight: 600;
}
option.rest-auto {
  color: #6c757d;
}
</style>
{% endblock %}

{% load extras %}
{% block content %}
<div class="container mt-5">
  {% if messages %}
  {% for message in messages %}
    <div class="alert 
                {% if message.tags == 'success' %}alert-success
                {% elif message.tags == 'error' %}alert-danger
                {% else %}alert-info{% endif %}
                alert-dismissible fade show text-center mx-auto w-75" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="閉じる"></button>
    </div>
  {% endfor %}
{% endif %}

  <h5 class="text-secondary ms-1 mb-4">シフト作成</h5>

  <div class="row">
    <div class="col-md-3 d-flex justify-content-center">
      <div class="mt-5">
        <ul class="list-unstyled">
          <li>
            <a href="{% url 'shifts:shift_pattern' %}" class="text-primary text-decoration-none return-link d-inline-block mb-3">
              シフトパターン登録
            </a>
          </li>
          <li>
            <a href="{% url 'shifts:pattern_assignment_summaries' %}" class="text-primary text-decoration-none return-link d-inline-block mb-3">
              シフトのバランスチェック
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="col-md-9">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <a href="?month={{ prev_month_str }}" class="btn btn-sm btn-outline-secondary me-3">&laquo;</a>
        <h3 class="m-0">{{ current_month.year }}年{{ current_month.month }}月</h3>
        <a href="?month={{ next_month_str }}" class="btn btn-sm btn-outline-secondary ms-3">&raquo;</a>
      </div>

      <p class="text-dark small mb-2 shift-description" style="font-size: 0.95rem;">
          各日のチェックボックスにチェックを入れると、その日の全員のシフトが「休」になります。<br>
          希望休は「<span class="text-primary fw-bold">休</span>」と表示されます。<br>
          <i class="fa-solid fa-comment text-danger"></i>にカーソルを合わせるとコメントを確認できます。
      </p>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead class="table-light">
          <tr>
            <th class="username-header"></th>
            {% for day in calendar_days %}
              <th>
                {{ day.day }}<br>
                <small>{{ day|date:"(D)" }}</small><br>
                <input type="checkbox" class="rest-day-checkbox" data-date="{{ day|date:'Y-m-d' }}">
              </th>
            {% endfor %}
          </tr>
        </thead>

          <tbody>
            {% for user in users %}
              <tr>
                <td class="username-cell">{{ user.name }}</td>
                {% for day in calendar_days %}
                  <td class="shift-cell">
                    {% with us=shift_dict|get_item:user.id|get_item:day %}
                      {% with comment=comment_dict|get_item:user.id|get_item:day.day %}
                        {% if comment %}
                          <i class="fa-solid fa-comment text-danger"
                                role="button"
                                tabindex="0"
                                data-bs-toggle="popover"
                                data-bs-trigger="hover"
                                data-bs-placement="top"
                                data-bs-title="コメント"
                                data-bs-content="{{ comment }}">
                          </i><br>
                        {% endif %}
                      {% endwith %}

                      {% with rest_type=rest_type_dict|get_item:user.id|get_item:day.day %}
                        <select 
                          class="form-select form-select-sm
                            {% if us.shift is None and us.is_error %} border-danger{% endif %}
                            {% if error_dict|get_item:user.id|get_item:day.day %} border-danger{% endif %}
                            {% if not us.shift and not us.is_error %}
                              {% if rest_type == 'request' %} rest-blue
                              {% else %} rest-gray
                              {% endif %}
                            {% endif %}"
                          data-user-id="{{ user.id }}"
                          data-date="{{ day|date:'Y-m-d'}}"
                          data-shift-id="{{ us.shift.id|default:'' }}"
                          data-rest-type="{{ rest_type|default:'' }}"> 
                      
                          {% if us.is_error %}
                            <option value="__ERROR__" selected></option>
                          {% endif %}

                          <option value=""
                            class="{% if rest_type_dict|get_item:user.id|get_item:day.day == 'request' %}rest-request{% else %}rest-auto{% endif %}"
                            {% if not us.shift and not us.is_error %}selected{% endif %}>
                            休
                          </option>

                          {% for pattern in patterns %}
                            <option value="{{ pattern.id }}"
                              {% if us.shift and us.shift.pattern.id == pattern.id %}selected{% endif %}>
                              {{ pattern.pattern_name }}
                            </option>
                          {% endfor %}
                        </select>
                      {% endwith %}
                    {% endwith %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
        <div class="d-flex justify-content-between align-items-start mt-4">

        <table class="table table-bordered me-4" style="width: auto;">
          <tbody>
            {% for pattern in patterns %}
              <tr>
                <td>{{ pattern.pattern_name }}</td>
                <td>{{ pattern.start_time|time:"H:i" }} ～ {{ pattern.end_time|time:"H:i" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <form id="auto-assign-form" method="POST" action="{% url 'shifts:shifts' %}?month={{ current_month|date:'Y-m' }}">
          {% csrf_token %}
          <input type="hidden" name="overwrite" value="true">
          <input type="hidden" name="month" value="{{ current_month|date:'Y-m' }}">
          <div id="rest-days-container"></div>
          <button type="submit" class="btn btn-lg gray-btn text-dark">シフトを自動作成する</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  function applyRestColor(sel) {
    sel.classList.remove('rest-blue', 'rest-gray');
    if (sel.value === '') {
      const t = sel.dataset.restType; // 'request' or 'auto' or ''
      if (t === 'request') {
        sel.classList.add('rest-blue');
      } else {
        sel.classList.add('rest-gray');
      }
    }
  }

  const selects = document.querySelectorAll('select[data-user-id][data-date]');
  selects.forEach(select => {

    applyRestColor(select);

    select.addEventListener('change', function () {
      const userId = this.dataset.userId;
      const date = this.dataset.date;
      const patternId = this.value;

      const label = this.options[this.selectedIndex]?.textContent.trim() || '';
      if (patternId === '') {
        this.classList.remove('border-danger');   
      } else if (patternId === '__ERROR__') {
        this.classList.add('border-danger');      
      } else if (!patternId) {
        this.classList.add('border-danger');      
      } else {
        this.classList.remove('border-danger'); 
      }


      if (patternId === '') {
        if (!this.dataset.restType) {
          this.dataset.restType = 'auto';
        }
      } else {
        this.classList.remove('rest-blue', 'rest-gray');
      }
      applyRestColor(this);

      fetch("{% url 'shifts:update_user_shift' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
          user_id: userId,
          date: date,
          pattern_id: patternId,
        })
      })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          alert('保存に失敗しました：' + (data.error || '不明なエラー'));
        } else {
          this.classList.remove('border-danger');
        }
      })
      .catch(error => {
        alert('通信エラーが発生しました');
        console.error(error);
      });
    });
  });

  document.querySelectorAll('.rest-day-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      const date = this.dataset.date;
      const checked = this.checked;

      fetch("{% url 'shifts:toggle_all_rest' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({
          date: date,
          checked: checked
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.ok) {
          document.querySelectorAll(`select[data-date="${date}"]`).forEach(sel => {
            if (checked) {
              const restOption = Array.from(sel.options).find(o => o.value === '');
              const errorOption = Array.from(sel.options).find(o => o.value === '__ERROR__');

              if (restOption && !sel.classList.contains("border-danger")) {
                restOption.selected = true;
              } else if (errorOption) {
                errorOption.selected = true;
              }
              sel.classList.remove("border-danger");

              sel.dataset.restType = 'auto';
              applyRestColor(sel);

            } else {
              const errorOption = Array.from(sel.options).find(
                o => o.value === '__ERROR__'
              );
              if (errorOption) {
                errorOption.selected = true;
              } else {
                sel.selectedIndex = -1;
              }
                 sel.classList.remove('rest-blue', 'rest-gray');
              sel.dispatchEvent(new Event('change', { bubbles: true }));
              return;
            }
            sel.dispatchEvent(new Event('change', { bubbles: true }));
          });
        } else {
          alert("更新に失敗しました: " + data.error);
        }
      })
      .catch(err => {
        alert("通信エラーが発生しました");
        console.error(err);
      });
    });
  });

  const popovers = [];
  const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
  popoverTriggerList.forEach(function (el) {
    const popover = new bootstrap.Popover(el, {
      trigger: 'hover',
      placement: 'top',
      container: 'body',
      html: true
    });
    popovers.push(popover);
  });

  window.addEventListener('scroll', function() {
    popovers.forEach(function (popover) {
      popover.hide();
    });
    document.querySelectorAll('.popover').forEach(function(el) {
      el.remove();
    });
  });

  document.getElementById('auto-assign-form').addEventListener('submit', function (e) {
    const container = document.getElementById('rest-days-container');
    container.innerHTML = '';
    document.querySelectorAll('.rest-day-checkbox:checked').forEach(cb => {
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = 'all_user_rest_days[]';
      inp.value = cb.dataset.date; 
      container.appendChild(inp);
    });
  });
});
</script>
{% endblock %}
