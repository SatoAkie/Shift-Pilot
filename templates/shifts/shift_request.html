{% extends "base.html" %}

{% block content %}
<style>
.calendar-cell {
     background-color: #e3f2fd !important; 
    border: 1px solid #dee2e6 !important; 
}
</style>

<div class="container mt-5">
    <h5 class="text-secondary ms-1 mb-4">ä¼‘ã¿å¸Œæœ›ç”³è«‹</h5>

    <div class="mb-3">
        <p class="fw-bold mb-1">
            æ—¥ä»˜ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ä¼‘æš‡å¸Œæœ›ã‚’é¸æŠã™ã‚‹ã‹ã€âœã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            æœ€å¾Œã«ã€Œç”³è«‹ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        </p>

        <div>
            <span class="me-3"><strong>ä¼‘ï¼š</strong>ä¼‘æš‡å¸Œæœ›</span>
            <span class="me-3"><strong>ğŸ’¬ï¼š</strong>ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Š</span>
            <span><strong>âœï¼š</strong>ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›</span>
        </div>
    </div>


    <div class="d-flex justify-content-center align-items-center mb-3">
        <a href="?month={{ prev_month_str }}" class="btn btn-sm btn-outline-secondary me-3">&laquo;</a>
        <h3 class="m-0">{{ current_month.year }}å¹´{{ current_month.month }}æœˆ</h3>
        <a href="?month={{ next_month_str }}" class="btn btn-sm btn-outline-secondary me-3">&raquo;</a>
    </div>

    <form method="POST">
        {% csrf_token %}
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert 
                            {% if message.tags == 'error' %}alert-danger
                            {% elif message.tags == 'success' %}alert-success
                            {% else %}alert-info{% endif %} 
                            alert-dismissible fade show text-center mx-auto w-75" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="é–‰ã˜ã‚‹"></button>
                </div>
            {% endfor %}
        {% endif %}


        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>æœˆ</th><th>ç«</th><th>æ°´</th><th>æœ¨</th><th>é‡‘</th><th class="text-primary">åœŸ</th><th class="text-danger">æ—¥</th></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    {% for day in calendar_days %}
                        {% if day.weekday == 0 and not forloop.first %}
                            </tr><tr>
                        {% endif %}

                        {% if day.month == month %}
                            <td class="calendar-cell" onclick="toggleRequest(this)">
                                <div class="d-flex flex-column align-item-center">
                                    <div>{{ day.day }}</div>
                                    <input type="checkbox" name="selected_dates" value="{{ day|date:'Y-m-d' }}"
                                        id="checkbox-{{ day }}" {% if day in existing_dates %}checked{% endif %}
                                        style="display: none;">

                                    <span id="mark-{{ day }}" class="fs-4">
                                    {% if day in comment_dates %}ğŸ’¬{% endif %}
                                    {% if day in day_off_dates %}ä¼‘{% endif %}
                                    </span>


                                    <button type="button" class="btn btn-sm border-0 mt-1"
                                        onclick="event.stopPropagation(); openCommentModal('{{ day }}')">
                                        âœ
                                    </button>
                                    <input type="hidden" name="comment_{{ day|date:'Y-m-d' }}" id="comment-hidden-{{ day }}" value="">
                                </div>
                            </td>
                        {% else %}
                            <td class="calendar-cell"></td>
                        {% endif %}
                    {% endfor %}
                </tr>
            </tbody>

        </table>

        <div class="modal fade" id="commentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ã‚³ãƒ¡ãƒ³ãƒˆå…¥åŠ›</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="commentInput" class="form-control" rows="4"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="saveComment()">ä¿å­˜</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mb-5">
            <button type="submit" class="btn btn-primary btn btn-primary btn-lg px-5 py-3">ç”³è«‹ã™ã‚‹</button>
        </div>
    </form>
</div>

<script>
    let currentTargetDay = "";

   function toggleRequest(td) {
    const checkbox = td.querySelector('input[type="checkbox"]');
    const span = td.querySelector('span');
    
    checkbox.checked = !checkbox.checked;

    if (checkbox.checked) {
        if (!span.innerHTML.includes('ä¼‘')) {
            span.innerHTML = 'ä¼‘' + span.innerHTML;
        }
    } else {
        span.innerHTML = span.innerHTML.replace('ä¼‘', '');
    }
}



    function openCommentModal(day){
        currentTargetDay = day;
        const hidden = document.getElementById("comment-hidden-"+day);
        document.getElementById("commentInput").value = hidden.value || "";
        const modal = new bootstrap.Modal(document.getElementById("commentModal"));
        modal.show();
    }

    function saveComment(){
    const text = document.getElementById("commentInput").value;
    const hidden = document.getElementById("comment-hidden-" + currentTargetDay);
    hidden.value = text;

    const markSpan = document.getElementById("mark-" + currentTargetDay);
    if (text.trim()) {
        if (!markSpan.innerHTML.includes('ğŸ’¬')) {
            markSpan.innerHTML = 'ğŸ’¬' + markSpan.innerHTML;
        }
    } else {
        markSpan.innerHTML = markSpan.innerHTML.replace('ğŸ’¬', '');
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById("commentModal"));
    modal.hide();
}

</script>
{% endblock %}