{% extends "base.html" %}
{% load range_tags extras %}

{% block content %}
<div class="container mt-5">
    <h5 class="text-secondary ms-1 mb-4">休み希望申請</h5>

    <div class="d-flex justify-content-center align-items-center mb-3">
        <a href="?month={{ prev_month_str }}" class="btn btn-sm btn-outline-secondary me-3">&laquo;</a>
        <h3 class="m-0">{{ current_month.year }}年{{ current_month.month }}月</h3>
        <a href="?month={{ next_month_str }}" class="btn btn-sm btn-outline-secondary me-3">&raquo;</a>
    </div>

    <form method="POST">
        {% csrf_token %}
        <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
                <tr>
                    <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    {% for day in calendar_days %}
                        {% if day.weekday == 0 and not forloop.first %}
                            </tr><tr>
                        {% endif %}
                         <td onclick="toggleRequest(this)">
                            {{ day.day }}
                            <input type="checkbox" name="selected_dates" value="{{ day }}"
                                id="checkbox-{{ day }}" {% if day in existing_dates %}checked{% endif %}
                                style="display: none;">
                            <span id="mark-{{ day }}">
                                {% if day in existing_dates %}○{% endif %}
                            </span>
                            <br>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-1"
                                onclick="openCommentModal('{{ day }}')">
                                ✎
                            </button> 
                            <input type="hidden" name="comment_{{ day }}" id="comment-hidden-{{ day }}" value="">     
                        </td>
                    {% endfor %}
                </tr>
            </tbody>
        </table>

        <div class="modal fade" id="commentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">コメント入力</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="commentInput" class="form-control" rows="4"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="saveComment()">保存</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-primary mt-5">申請する</button>
        </div>
    </form>
</div>

<script>
    let currentTargetDay = "";

    function toggleRequest(td) {
        const checkbox = td.querySelector('input[type="checkbox"]');
        const mark = td.querySelector('span');

        checkbox.checked = !checkbox.checked;
        mark.textContent = checkbox.checked ? '○' : '';
    }
    
    function openCommentModal(day){
        currentTargetDay = day;
        const hidden = document.getElementById("comment-hidden-"+day);
        document.getElementById("commentInput").value = hidden.value || "";
        const modal = new bootstrap.Modal(document.getElementById("commentModal"));
        modal.show();
    }

    function saveComment(){
        const text = document.getElementById("commentInput").value;
        document.getElementById("comment-hidden-" + currentTargetDay).value =text;
        const modal = bootstrap.Modal.getInstance(document.getElementById("commentModal"));
        modal.hide();
    }
</script>
{% endblock %}