{% extends "base.html" %}
{% load extras %}
{% block content %}

<style>
.pattern-input {
  width: 12rem !important;
}
.time-input {
  width: 8rem !important;
}
.number-input {
  width: 9rem !important;
}
.table td, .table th {
  padding-left: 2px !important;
  padding-right: 2px !important;
}
.d-flex.gap-2 {
  gap: 0.25rem !important;
}
#pattern-table th:nth-child(2),
#pattern-table td:nth-child(2) {
  width: 280px;
}
#pattern-table th {
  text-align: center !important;
  vertical-align: middle !important;
}
</style>


<div class="container mt-5">
    <h5 class="text-secondary ms-1 mb-4">シフトパターン登録</h5>

    {% if error_message %}
    <div class="alert alert-danger text-center">
        {{ error_message }}
    </div>
    {% endif %}

    {% if messages %}
    {% for message in messages %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <div class="text-center">
        {{ message }}
             </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="閉じる"></button>
        </div>
    {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <table class="table table-borderless text-center align-middle mb-4" id="pattern-table" style="width: 100%; max-width: 700px; margin: 0 auto;">
            <thead>
                <tr>
                    <th>パターン名</th>
                    <th>勤務時間</th>
                    <th>人数</th>
                    <th style="width: 10%;">削除</th>
                </tr>
            </thead>
            <tbody id="pattern-table-body">
                {% if patterns|length == 0 %}
                <tr>
                    <td>
                        <input type="text" name="pattern_name_1" value="" class="form-control text-center pattern-input" placeholder="パターン名" required>
                    </td>
                    <td>
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <input type="time" name="start_time_1" value="" class="form-control text-center time-input" style="width: 6rem;" placeholder="開始" required>
                            <span class="mx-1">～</span>
                            <input type="time" name="end_time_1" value="" class="form-control text-center time-input" style="width: 6rem;" placeholder="終了" required>
                        </div>
                    </td>
                    <td>
                        <input type="number" name="max_people_1" value="" class="form-control text-center number-input" min="1" placeholder="人数" required>
                    </td>
                    <td></td>
                </tr>
                {% endif %}


                {% for pattern in patterns %}
                <tr>
                    <td>
                        <input type="text"
                               name="pattern_name_{{ forloop.counter }}"
                               value="{{ pattern.pattern_name }}"
                               class="form-control text-center pattern-input"
                               placeholder="パターン名"
                               required>
                    </td>
                    <td>
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <input type="time"
                                   name="start_time_{{ forloop.counter }}"
                                   value="{{ pattern.start_time|time:'H:i' }}"
                                   class="form-control text-center time-input"
                                   style="width: 6rem;"
                                   required>
                            <span class="mx-1">～</span>
                            <input type="time"
                                   name="end_time_{{ forloop.counter }}"
                                   value="{{ pattern.end_time|time:'H:i' }}"
                                   class="form-control text-center time-input"
                                   style="width: 6rem;"
                                   required>
                        </div>
                    </td>
                    <td>
                        <input type="number"
                               name="max_people_{{ forloop.counter }}"
                               value="{{ pattern.max_people }}"
                               class="form-control text-center number-input"
                               min="1"
                               placeholder="人数"
                               required>
                        <input type="hidden" 
                               name="id_{{ forloop.counter }}" 
                               value="{{ pattern.id }}">
                    </td>
                    <td>

                        <button type="submit" class="btn btn-danger btn-sm" formaction="{% url 'shifts:delete_pattern' pattern.id %}" formmethod="post"
                            onclick="return confirm('本当に削除しますか？');">削除</button>
                        {% csrf_token %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if patterns|length == 0 %}
            <input type="hidden" id="total-input" name="total" value="1">
        {% else %}
            <input type="hidden" id="total-input" name="total" value="{{ patterns|length }}">
        {% endif %}

        <div class="text-center mb-4">
            <button type="button" id="add-row-btn" class="btn btn-outline-secondary">シフトパターンを追加</button>
        </div>

        <div class="text-center mb-5">
            <button type="submit" class="btn btn-primary px-5">登録</button>
        </div>
    </form>
</div>

<script>
{% if patterns|length == 0 %}
  let rowCount = 1;
{% else %}
  let rowCount = {{ patterns|length }};
{% endif %}

document.getElementById('add-row-btn').addEventListener('click', function () {
    rowCount++;
    const tbody = document.getElementById('pattern-table-body');

    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <input type="text" name="pattern_name_${rowCount}" value="" class="form-control text-center" placeholder="パターン名" required>
        </td>
        <td>
            <div class="d-flex justify-content-center align-items-center gap-2">
                <input type="time" name="start_time_${rowCount}" value="" class="form-control text-center" style="width: 6rem;" placeholder="開始" required>
                <span class="mx-1">～</span>
                <input type="time" name="end_time_${rowCount}" value="" class="form-control text-center" style="width: 6rem;" placeholder="終了" required>
            </div>
        </td>
        <td>
            <input type="number" name="max_people_${rowCount}" value="" class="form-control text-center" min="1" placeholder="人数" required>
        </td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" 
                onclick="this.closest('tr').remove()">削除</button>
        </td>
    `;
    tbody.appendChild(row);

    document.getElementById('total-input').value = rowCount;
});

window.addEventListener('DOMContentLoaded', function () {
    const active = document.activeElement;
    if (active && active.tagName.toLowerCase() === 'input') {
        active.blur();
    }
});
</script>
{% endblock %}
